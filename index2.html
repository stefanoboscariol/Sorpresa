<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TANTI AUGURI FLA‚ú®</title>
  <style>
    * { 
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #89f7fe, #66a6ff);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: #333;
      overflow: hidden;
      position: relative;
    }

    .card {
      background: #f0f8ff;
      padding: clamp(1.5rem, 5vw, 2.5rem) clamp(1.2rem, 4vw, 2rem);
      border-radius: clamp(16px, 4vw, 24px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      max-width: min(420px, 90vw);
      width: 90%;
      text-align: center;
      animation: pop 0.6s ease-out;
      position: relative;
      margin: 1rem;
    }

    @keyframes pop {
      from { transform: scale(0.85); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    h1 { 
      font-size: clamp(1.4rem, 5vw, 1.9rem);
      margin-bottom: 1rem;
      color: #2575fc;
      line-height: 1.2;
    }
    
    p {
      font-size: clamp(0.9rem, 3.5vw, 1.05rem);
      line-height: 1.5;
      margin-bottom: 1rem;
    }

    button {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      border: none;
      color: white;
      font-size: clamp(0.9rem, 3.5vw, 1rem);
      padding: clamp(0.6rem, 2.5vw, 0.7rem) clamp(1.2rem, 4vw, 1.4rem);
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(38,79,255,0.4);
      margin-top: 0.5rem;
      transition: transform 0.2s, box-shadow 0.2s;
      touch-action: manipulation;
      min-height: 44px; /* Touch target size */
    }

    button:active {
      transform: scale(0.95);
      box-shadow: 0 4px 10px rgba(38,79,255,0.3);
    }

    .hidden { display: none; }
    
    .choices {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }
    
    .choices button {
      flex: 1 1 auto;
      min-width: 80px;
      margin: 0;
    }

    .dots {
      position: relative;
      width: 100%;
      aspect-ratio: 2 / 1;
      max-height: min(200px, 40vh);
      margin: 1rem auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dot {
      width: clamp(18px, 5vw, 22px);
      height: clamp(18px, 5vw, 22px);
      background: #2575fc;
      border-radius: 50%;
      position: absolute;
      cursor: pointer;
      z-index: 2;
      top: var(--top);
      left: var(--left);
      transform: translate(-50%, -50%);
      transition: transform 0.2s;
      touch-action: manipulation;
    }

    .dot:active {
      transform: translate(-50%, -50%) scale(1.2);
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    #tapGrid {
      position: relative;
      width: 100%;
      height: clamp(150px, 35vh, 200px);
      border: 2px dashed #2575fc;
      border-radius: clamp(12px, 3vw, 16px);
      margin: 1rem 0;
      overflow: hidden;
    }

    .lightning {
      position: absolute;
      font-size: clamp(1.5rem, 5vw, 2rem);
      cursor: pointer;
      touch-action: manipulation;
      user-select: none;
      transition: transform 0.1s;
    }

    .lightning:active {
      transform: scale(1.3);
    }

    .heart, .emoji {
      position: absolute;
      font-size: clamp(20px, 5vw, 26px);
      animation: floatUp 6s linear infinite;
      opacity: 0.7;
      pointer-events: none;
      user-select: none;
    }

    @keyframes floatUp {
      from { transform: translateY(0); opacity: 0.7; }
      to { transform: translateY(-110vh); opacity: 0; }
    }

    #tapScore {
      font-weight: bold;
      font-size: clamp(1rem, 4vw, 1.1rem);
      color: #2575fc;
      min-height: 1.5rem;
    }

    /* Ottimizzazioni per schermi piccoli */
    @media (max-width: 400px) {
      .card {
        width: 95%;
      }
      
      .choices button {
        font-size: 0.85rem;
        padding: 0.6rem 1rem;
      }
    }

    /* Ottimizzazioni per schermi molto piccoli in altezza */
    @media (max-height: 600px) {
      .card {
        padding: 1rem;
        margin: 0.5rem;
      }
      
      h1 {
        margin-bottom: 0.5rem;
      }
      
      p {
        margin-bottom: 0.5rem;
      }
      
      .dots {
        margin: 0.5rem auto;
      }
    }

    /* Landscape mode su mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      .card {
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
    }
  </style>
</head>

<body>

<!-- LIVELLO 1 -->
<div class="card" id="lvl1">
  <h1>üëã Ciao Flavietta!</h1>
  <p>Questa √® una piccola sorpresa‚Ä¶<br>ma per arrivare in fondo dovrai <b>guadagnartela</b> üòâ</p>
  <button onclick="goTo('lvl1','lvl2')">Iniziamo üéÆ</button>
</div>

<!-- LIVELLO 2 -->
<div class="card hidden" id="lvl2">
  <h1>üß© Livello 1</h1>
  <p>Unisci i puntini in ordine</p>
  <div class="dots">
    <canvas id="lineCanvas"></canvas>
    <div class="dot" style="--top: 67%; --left: 11%;" onclick="hitDot(1,this)" ontouchstart="hitDot(1,this)"></div>
    <div class="dot" style="--top: 22%; --left: 47%;" onclick="hitDot(2,this)" ontouchstart="hitDot(2,this)"></div>
    <div class="dot" style="--top: 67%; --left: 83%;" onclick="hitDot(3,this)" ontouchstart="hitDot(3,this)"></div>
  </div>
</div>

<!-- LIVELLO 3 -->
<div class="card hidden" id="lvl3">
  <h1>‚ûï Livello 2</h1>
  <p><b>Quanto fa 7 √ó 6?</b></p>
  <div class="choices">
    <button onclick="mathWrong()">36</button>
    <button onclick="mathRight()">42</button>
    <button onclick="mathWrong()">48</button>
  </div>
  <p id="mathMsg"></p>
</div>

<!-- LIVELLO 4 -->
<div class="card hidden" id="lvl4">
  <h1>‚ö° Livello 3</h1>
  <p>Tocca pi√π fulmini possibile ‚ö°</p>
  <p><small>Hai <b>1 minuto</b> ‚è±Ô∏è</small></p>
  <div id="tapGrid"></div>
  <p id="tapScore"></p>
</div>

<!-- LIVELLO 5 -->
<div class="card hidden" id="lvl5">
  <h1>üòé Livello 4</h1>
  <p>Carino eh?</p>
  <div class="choices">
    <button onclick="choiceWrong()">Nhaa ü§î</button>
    <button onclick="choiceRight()">Carino dai üéâ</button>
  </div>
</div>

<!-- LIVELLO FINALE -->
<div class="card hidden" id="lvl6">
  <h1>üéâ AUGURI FLA üéâ</h1>
  <p>
    Un altro capitolo sta per iniziare üèÜ<br>
    Non potr√† esser bello come lo scorso,<br>
    in cui ho fatto capolino io (hihihi),<br>
    ma proveremo a renderlo memorabile üíôü´∂üèª
  </p>
  <button onclick="spawnFinalElements()">‚ú® Guarda ‚ú®</button>
</div>

<script>
  function goTo(from,to){
    document.getElementById(from).classList.add('hidden');
    document.getElementById(to).classList.remove('hidden');
  }

  /* Puntini con linee - responsive */
  let currentDot = 1;
  let lastPos = null;
  const canvas = document.getElementById('lineCanvas');
  const ctx = canvas.getContext('2d');

  function resizeCanvas() {
    const dotsContainer = canvas.parentElement;
    const rect = dotsContainer.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    
    // Ridisegna le linee esistenti dopo il resize
    if (lastPos && currentDot > 1) {
      redrawLines();
    }
  }

  let dotPositions = [];

  function hitDot(n, el){
    if(n !== currentDot) return;
    
    // Previeni il doppio tap
    event.preventDefault();
    
    resizeCanvas();
    
    const rect = el.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    
    const dotSize = el.offsetWidth / 2;
    const x = (rect.left - canvasRect.left) + dotSize;
    const y = (rect.top - canvasRect.top) + dotSize;

    dotPositions.push({x, y});

    if(lastPos){
      ctx.beginPath();
      ctx.moveTo(lastPos.x, lastPos.y);
      ctx.lineTo(x, y);
      ctx.strokeStyle = '#2575fc';
      ctx.lineWidth = Math.max(3, canvas.width / 100);
      ctx.lineCap = 'round';
      ctx.stroke();
    }
    
    lastPos = {x,y};
    currentDot++;
    
    if(currentDot === 4){
      setTimeout(()=>{
        dotPositions = [];
        lastPos = null;
        currentDot = 1;
        goTo('lvl2','lvl3');
      },600);
    }
  }

  function redrawLines() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = 1; i < dotPositions.length; i++) {
      ctx.beginPath();
      ctx.moveTo(dotPositions[i-1].x, dotPositions[i-1].y);
      ctx.lineTo(dotPositions[i].x, dotPositions[i].y);
      ctx.strokeStyle = '#2575fc';
      ctx.lineWidth = Math.max(3, canvas.width / 100);
      ctx.lineCap = 'round';
      ctx.stroke();
    }
  }

  // Gestione responsive
  window.addEventListener('load', resizeCanvas);
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', () => {
    setTimeout(resizeCanvas, 100);
  });

  /* Matematica */
  function mathWrong(){
    document.getElementById('mathMsg').textContent = 'Riprova üòè';
  }
  function mathRight(){
    document.getElementById('mathMsg').textContent = 'Perfetto üòé';
    setTimeout(()=>goTo('lvl3','lvl4'),900);
  }

  /* Fulmini ‚Äì 1 minuto - ottimizzato per touch */
  let tapGameInterval;
  let tapGameTimeout;

  function startTapGame(){
    const grid = document.getElementById('tapGrid');
    const score = document.getElementById('tapScore');
    grid.innerHTML='';
    let hits = 0;

    // Pulisci eventuali timer precedenti
    if (tapGameInterval) clearInterval(tapGameInterval);
    if (tapGameTimeout) clearTimeout(tapGameTimeout);

    score.textContent = 'Fulmini: 0';

    tapGameInterval = setInterval(()=>{
      const bolt = document.createElement('div');
      bolt.className = 'lightning';
      bolt.textContent='‚ö°';
      
      const gridRect = grid.getBoundingClientRect();
      const boltSize = 40; // Stima dimensione emoji
      
      bolt.style.left = Math.random() * (gridRect.width - boltSize) + 'px';
      bolt.style.top = Math.random() * (gridRect.height - boltSize) + 'px';
      
      const tapHandler = (e) => {
        e.preventDefault();
        hits++;
        bolt.remove();
        score.textContent = `Fulmini: ${hits}`;
      };
      
      bolt.onclick = tapHandler;
      bolt.ontouchstart = tapHandler;
      
      grid.appendChild(bolt);
      setTimeout(()=>bolt.remove(), 2500);
    }, 700);

    tapGameTimeout = setTimeout(()=>{
      clearInterval(tapGameInterval);
      grid.innerHTML = '';
      score.textContent = `Tempo scaduto! Fulmini: ${hits}`;
      setTimeout(()=>goTo('lvl4','lvl5'), 1500);
    }, 60000); // 1 minuto
  }

  new MutationObserver((mutations)=>{
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        const lvl4 = document.getElementById('lvl4');
        if (!lvl4.classList.contains('hidden')) {
          setTimeout(startTapGame, 100);
        }
      }
    });
  }).observe(document.getElementById('lvl4'), {attributes: true});

  function choiceWrong(){ alert('Daiiii üòè'); }
  function choiceRight(){ goTo('lvl5','lvl6'); }

  /* Finale ‚Äì cuori ed emoji */
  function spawnFinalElements(){
    const vw = window.innerWidth;
    
    for(let i=0; i<6; i++){
      setTimeout(() => {
        const heart = document.createElement('div');
        heart.className = 'heart';
        heart.textContent = 'üíô';
        heart.style.left = Math.random() * vw + 'px';
        heart.style.animationDelay = Math.random() * 2 + 's';
        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 6000);
      }, i * 300);
    }

    for(let i=0; i<10; i++){
      setTimeout(() => {
        const emoji = document.createElement('div');
        emoji.className = 'emoji';
        emoji.textContent = 'ü´∂üèª';
        emoji.style.left = Math.random() * vw + 'px';
        emoji.style.animationDelay = Math.random() * 2 + 's';
        document.body.appendChild(emoji);
        setTimeout(() => emoji.remove(), 6000);
      }, i * 200);
    }
  }

  // Previeni zoom accidentale su doppio tap
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (event) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
</script>

</body>
</html>
